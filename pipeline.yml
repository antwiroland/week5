AWSTemplateFormatVersion: '2010-09-09'
Description: 'CodePipeline for ECS Blue-Green Deployment'

Parameters:
  AppName:
    Type: String
    Default: 'java-full-stack'
  DeploymentTimestamp:
    Type: String
    Default: "default"

Resources:
  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub ${AppName}-Pipeline
      RoleArn: !ImportValue
        !Sub '${AppName}-CodePipelineServiceRoleArn'
      ArtifactStore:
        Type: S3
        Location: !ImportValue
          !Sub '${AppName}-ArtifactBucketName'
      Stages:
        - Name: Source
          Actions:
            - Name: S3Source
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: S3
                Version: '1'
              Configuration:
                S3Bucket: !ImportValue
                  !Sub '${AppName}-ArtifactBucketName'
                S3ObjectKey: deployment-artifacts/latest.zip
                PollForSourceChanges: false
              OutputArtifacts:
                - Name: SourceArtifact
              RunOrder: 1

        - Name: Deploy
          Actions:
            - Name: ECSBlueGreenDeploy
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CodeDeployToECS
                Version: '1'
              Configuration:
                ApplicationName: !ImportValue
                  !Sub '${AppName}-CodeDeployAppName'
                DeploymentGroupName: !ImportValue
                  !Sub '${AppName}-CodeDeployDeploymentGroupName'
                TaskDefinitionTemplateArtifact: SourceArtifact
                TaskDefinitionTemplatePath: "taskdef.json"
                AppSpecTemplateArtifact: SourceArtifact
                AppSpecTemplatePath: "appspec.yml"
              InputArtifacts:
                - Name: SourceArtifact
              RunOrder: 1

Outputs:
  PipelineName:
    Description: 'CodePipeline Name'
    Value: !Ref CodePipeline
  DeploymentTimestamp:
    Description: 'Timestamp of last deployment'
    Value: !Ref DeploymentTimestamp
